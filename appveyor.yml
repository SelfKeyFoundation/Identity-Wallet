image: Visual Studio 2017
environment:
    OSENV: windows
    NO_PROXY: 127.0.0.1,localhost
    JEST_JUNIT_OUTPUT_DIR: dist\junit'
    JEST_JUNIT_UNIQUE_OUTPUT_NAME: 'true'
    encryptedkey:
        secure: 8HCeZ0WW/f09cU7PgV31q14Xy46vU/2dYHnP0ZCpi/tLvVzr2gnY+BZ99S1u1cAHJNdAyRX/pp91L91KiXdh/2ZuE1fqAXcaVo2/j4VB01c=
    encryptedkey2:
        secure: 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
    encryptediv:
        secure: UUs7HYg9U50gP2ryZoTtH2WaU0BhoSLBhsOIQRgHpj+oluUpXTv/O4spjDRC9qOT
    GH_TOKEN:
        secure: 0GkJ9XwbxX/r97LuhCPAK3n5jxV1lG1Tm1nhHuixoGwFCoLb7lcSNceAUYPqEle+
    MM_URL:
        secure: QfAI68E/qnE7UZMvjqIQIkiMASDooWknt2psZWeawGTa8iu4cuNWd5P+ronxVphBXYAPuwEywIadwnxAj4WmIkL6rfGd/OQo1hlsNfEwYCo=
    SENTRY_DSN:
        secure: z2HN+AfLblFuqEDtdIOzj9ngBI0H+JWU2A7EdUX70iUfTU/dQYoDkCQAnLG87K90TYcsQF7eXzQ0dhZvfuRWFmD2iQfXJnTc2fnbe4trtd0=
    nodejs_version: 10.13.0
platform:
    - x64
init:
    - tzutil /s "UTC"
    - git config --global core.autocrlf input
cache:
    # - node_modules
    - '%LOCALAPPDATA%/Yarn'
install:
    - ps: Start-FileDownload 'https://storage.googleapis.com/win-open-ssl/Win64OpenSSL-1_0_2r.exe'
    - ps: Start-Process 'Win64OpenSSL-1_0_2r.exe' -ArgumentList '/silent /verysilent /sp- /suppressmsgboxes' -Wait
    - ps: Start-FileDownload 'https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe'
    - ps: Start-Process 'GoogleCloudSDKInstaller.exe' -ArgumentList '/S' -Wait
    - refreshenv
    - ps: Install-Product node $env:nodejs_version x64
    - npm config set msvs_version 2015 --global
    - set PATH=C:\Ruby22\bin;%PATH%
    #- gem install sass compass
    - npm i -g yarn
    - yarn install-all
build_script:
    - echo {"dsn":"%SENTRY_DSN%"} > src\assets\data\sentry.json
    - set DEBUG=electron-builder
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[auto-update-test] yarn auto-update-version
    - yarn dist --publish=never
test_script:
    - yarn test:unit:ci
    # - yarn test:e2e disabling it for now as it may be leaving an electron app open and the release script cannot release because a file locked
on_finish:
    # upload test results via rest-api
    - ps: |
          $wc = New-Object 'System.Net.WebClient'
          Get-ChildItem . -Name -Recurse 'junit-*.xml'  |
          Foreach-Object {
              $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $_))
          }
deploy_script:
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[dev] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[release] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[nightly] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[auto-update-test] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if NOT [%APPVEYOR_REPO_BRANCH%]==[%APPVEYOR_REPO_BRANCH:staging=%] set _tempvar=1

    - if defined _tempvar for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /format:list') do set datetime=%%I
    - if defined _tempvar set datetime=%datetime:~0,4%.%datetime:~4,2%.%datetime:~6,2%.%datetime:~8,2%
    - if defined _tempvar C:\OpenSSL-Win64\bin\openssl aes-256-cbc -K "%encryptedkey%" -iv "%encryptediv%" -in client-secret.json.enc -out client-secret.json -d
    - if defined _tempvar ECHO %encryptedkey2% > client-secret2.json
    - if defined _tempvar gcloud auth activate-service-account --key-file client-secret2.json
    - gsutil cp dist/*.exe gs://sk-builds/%APPVEYOR_REPO_BRANCH%/%datetime%/
after_deploy:
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[master] yarn publish-build
