image: Visual Studio 2017
environment:
  OSENV: windows
  NO_PROXY: 127.0.0.1,localhost
  JEST_JUNIT_OUTPUT_DIR: dist\junit'
  JEST_JUNIT_UNIQUE_OUTPUT_NAME: "true"
  encryptedkey:
    secure: 8HCeZ0WW/f09cU7PgV31q14Xy46vU/2dYHnP0ZCpi/tLvVzr2gnY+BZ99S1u1cAHJNdAyRX/pp91L91KiXdh/2ZuE1fqAXcaVo2/j4VB01c=
  encryptediv:
    secure: UUs7HYg9U50gP2ryZoTtH2WaU0BhoSLBhsOIQRgHpj+oluUpXTv/O4spjDRC9qOT
  GH_TOKEN:
    secure: HmFC4GOzQ3zCX7fwJx+9CZGf+BphWZ1Vh/s1it0LV1w/4QcM0JaIZJ5mwWCl/A6Y
  CSC_LINK:
    secure: 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
  CSC_KEY_PASSWORD:
    secure: LXKG/dtrGP5ygqv4jD61pA==
  MM_URL:
    secure: QfAI68E/qnE7UZMvjqIQIkiMASDooWknt2psZWeawGTa8iu4cuNWd5P+ronxVphBXYAPuwEywIadwnxAj4WmIkL6rfGd/OQo1hlsNfEwYCo=
  SENTRY_DSN:
    secure: z2HN+AfLblFuqEDtdIOzj9ngBI0H+JWU2A7EdUX70iUfTU/dQYoDkCQAnLG87K90TYcsQF7eXzQ0dhZvfuRWFmD2iQfXJnTc2fnbe4trtd0=
  nodejs_version: 10.13.0
platform:
  - x64
init:
  - tzutil /s "UTC"
  - git config --global core.autocrlf input
cache:
  # - node_modules
  - '%LOCALAPPDATA%/Yarn'
install:
  - ps: Start-FileDownload 'https://storage.googleapis.com/win-open-ssl/Win64OpenSSL-1_0_2r.exe'
  - ps: Start-Process 'Win64OpenSSL-1_0_2r.exe' -ArgumentList '/silent /verysilent /sp- /suppressmsgboxes' -Wait
  - ps: Start-FileDownload 'https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe'
  - ps: Start-Process 'GoogleCloudSDKInstaller.exe' -ArgumentList '/S' -Wait
  - refreshenv
  - ps: Install-Product node $env:nodejs_version x64
  - npm config set msvs_version 2015 --global
  - set PATH=C:\Ruby22\bin;%PATH%
  - gem install sass compass
  - npm i -g yarn
  - yarn install-all
build_script:
  - echo {"dsn":"%SENTRY_DSN%"} > src\assets\data\sentry.json
  - set DEBUG=electron-builder
  - yarn dist --publish=never
test_script:
  - yarn test:unit:ci
 # - yarn test:e2e disabling it for now as it may be leaving an electron app open and the release script cannot release because a file locked
on_finish:
# upload test results via rest-api
  - ps: |
        $wc = New-Object 'System.Net.WebClient'
        Get-ChildItem . -Name -Recurse 'junit-*.xml'  |
        Foreach-Object {
            $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $_))
        }
deploy_script:
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[dev] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[release] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[nightly] set _tempvar=1
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if NOT [%APPVEYOR_REPO_BRANCH%]==[%APPVEYOR_REPO_BRANCH:staging=%] set _tempvar=1

    - if defined _tempvar for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /format:list') do set datetime=%%I
    - if defined _tempvar set datetime=%datetime:~0,4%.%datetime:~4,2%.%datetime:~6,2%.%datetime:~8,2%
    - if defined _tempvar C:\OpenSSL-Win64\bin\openssl aes-256-cbc -K "%encryptedkey%" -iv "%encryptediv%" -in client-secret.json.enc -out client-secret.json -d
    - if defined _tempvar gcloud auth activate-service-account --key-file client-secret.json
    - if defined _tempvar gsutil cp dist/*.exe gs://selfkey-builds/%APPVEYOR_REPO_BRANCH%/%datetime%/
after_deploy:
    - if [%APPVEYOR_PULL_REQUEST_NUMBER%]==[] if [%APPVEYOR_REPO_BRANCH%]==[master] yarn publish-build

