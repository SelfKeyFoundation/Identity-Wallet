// let data = {
// 	'1': {
// 		id: 1,
// 		walletId: 1,
// 		idAttributeType: 'first_name',
// 		items: [
// 			{
// 				id: 'f90885fd79bd52cb7f9122c3',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419290,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: '5107f5ef7b61808d8b06e1e5',
// 						staticData: {
// 							line1: 'test1'
// 						},
// 						documentId: null,
// 						order: 0,
// 						createdAt: 1532006419290,
// 						updatedAt: null
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419317,
// 		updatedAt: 1532006419317
// 	},
// 	'2': {
// 		id: 2,
// 		walletId: 1,
// 		idAttributeType: 'email',
// 		items: [
// 			{
// 				id: '58d51b8bd23119fa620f6c9a',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419291,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: 'e7a24dc704b03fe776922260',
// 						staticData: {
// 							line1: 'test@email.com'
// 						},
// 						documentId: null,
// 						order: 0,
// 						createdAt: 1532006419291,
// 						updatedAt: null
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419326,
// 		updatedAt: 1532006474815
// 	},
// 	'3': {
// 		id: 3,
// 		walletId: 1,
// 		idAttributeType: 'id_selfie',
// 		items: [
// 			{
// 				id: '6d59b52fc8d68d041f16b490',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419291,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: 'c37a9ef73d808dc8d55399a9',
// 						staticData: {},
// 						documentId: 2,
// 						order: 0,
// 						createdAt: 1532006419291,
// 						updatedAt: null,
// 						documentName: 'LWScreenShot 2018-07-17 at 5.02.11 PM (2).png'
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419328,
// 		updatedAt: 1532006460169
// 	},
// 	'4': {
// 		id: 4,
// 		walletId: 1,
// 		idAttributeType: 'national_id',
// 		items: [
// 			{
// 				id: '0a7e450d09b7f9824a04defe',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419291,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: '2c411eae6209996dfcec9032',
// 						staticData: {},
// 						documentId: 1,
// 						order: 0,
// 						createdAt: 1532006419291,
// 						updatedAt: null,
// 						documentName: 'selfkey-identity-attributes.png'
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419330,
// 		updatedAt: 1532006437309
// 	},
// 	'5': {
// 		id: 5,
// 		walletId: 1,
// 		idAttributeType: 'country_of_residency',
// 		items: [
// 			{
// 				id: '4d5bc420c81194d7c3fe1491',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419290,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: '5a5e00952849ff9209956f9e',
// 						staticData: {
// 							line1: 'Isle of Man'
// 						},
// 						documentId: null,
// 						order: 0,
// 						createdAt: 1532006419291,
// 						updatedAt: null
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419331,
// 		updatedAt: 1532006419331
// 	},
// 	'6': {
// 		id: 6,
// 		walletId: 1,
// 		idAttributeType: 'middle_name',
// 		items: [
// 			{
// 				id: '6dd2c9ef44476fbc13b9a1dc',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419290,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: 'b1d4e4b05647c91eb9a47c7e',
// 						staticData: {
// 							line1: 'test2'
// 						},
// 						documentId: null,
// 						order: 0,
// 						createdAt: 1532006419290,
// 						updatedAt: null
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419333,
// 		updatedAt: 1532006419333
// 	},
// 	'7': {
// 		id: 7,
// 		walletId: 1,
// 		idAttributeType: 'last_name',
// 		items: [
// 			{
// 				id: 'dc101afa9e40cbdc96588424',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				createdAt: 1532006419290,
// 				updatedAt: null,
// 				values: [
// 					{
// 						id: 'a7bc626ccb29c6937b75afa6',
// 						staticData: {
// 							line1: 'test3'
// 						},
// 						documentId: null,
// 						order: 0,
// 						createdAt: 1532006419290,
// 						updatedAt: null
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006419335,
// 		updatedAt: 1532006419335
// 	},
// 	'8': {
// 		id: 8,
// 		walletId: 1,
// 		idAttributeType: 'public_key',
// 		items: [
// 			{
// 				id: '0016e21b93a9e4f045a0ee46',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: '6e9053bec5722d190bf7e949',
// 						order: 0,
// 						staticData: {
// 							line1: 'fsdfsdfds'
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006501252,
// 		updatedAt: 1532006501252
// 	},
// 	'9': {
// 		id: 9,
// 		walletId: 1,
// 		idAttributeType: 'physical_address',
// 		items: [
// 			{
// 				id: '76b67f891fcf27ff5c820b11',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: 'df6cd89db9b3807ebd05c858',
// 						order: 0,
// 						staticData: {
// 							line1: 'street1',
// 							line2: 'street2',
// 							line3: 'New York',
// 							line4: 'SOSKA',
// 							line5: '1234',
// 							line6: 'Albania'
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006546015,
// 		updatedAt: 1532006546015
// 	},
// 	'10': {
// 		id: 10,
// 		walletId: 1,
// 		idAttributeType: 'work_place',
// 		items: [
// 			{
// 				id: '7e76692359690fb1cb0b25a6',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: 'f76d9d7db347a4249de20ea1',
// 						order: 0,
// 						staticData: {
// 							line1: 'work1',
// 							line2: 'work2',
// 							line3: 'lviv',
// 							line4: '42',
// 							line5: '1231',
// 							line6: 'Algeria'
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006577037,
// 		updatedAt: 1532006577037
// 	},
// 	'11': {
// 		id: 11,
// 		walletId: 1,
// 		idAttributeType: 'birthdate',
// 		items: [
// 			{
// 				id: '5f4f2b412d5be296db3ee5cd',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: '02cd1c4c7cc465bf62c38e5d',
// 						order: 0,
// 						staticData: {
// 							line1: 1532638800000
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006597598,
// 		updatedAt: 1532006597598
// 	},
// 	'12': {
// 		id: 12,
// 		walletId: 1,
// 		idAttributeType: 'tax_id_number',
// 		items: [
// 			{
// 				id: '090c10faa5986b6a137035e2',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: 'd814c235ffc46680d40e4b6d',
// 						order: 0,
// 						staticData: {
// 							line1: '123123123'
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006607189,
// 		updatedAt: 1532006607189
// 	},
// 	'13': {
// 		id: 13,
// 		walletId: 1,
// 		idAttributeType: 'nationality',
// 		items: [
// 			{
// 				id: 'e31ec431e54316be6279e790',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: '6a15614681bcdbe4e9e4ae86',
// 						order: 0,
// 						staticData: {
// 							line1: 'Albania'
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006615306,

// 		updatedAt: 1532006615306
// 	},
// 	'14': {
// 		id: 14,
// 		walletId: 1,
// 		idAttributeType: 'phonenumber_countrycode',
// 		items: [
// 			{
// 				id: '9fe3f9725cc6a59ed8305e72',
// 				name: null,
// 				isVerified: 0,
// 				order: 0,
// 				values: [
// 					{
// 						id: 'd17dd07239ae35dc2529fe47',
// 						order: 0,
// 						staticData: {
// 							line1: '+358',
// 							line2: 231231231
// 						}
// 					}
// 				]
// 			}
// 		],
// 		order: 0,
// 		createdAt: 1532006625127,
// 		updatedAt: 1532006625127
// 	}
// };

function transformAttrs(acc, srcAttr) {
	const walletId = srcAttr.walletId;
	let itm = {
		walletId,
		type: srcAttr.idAttributeType,
		createdAt: srcAttr.createdAt,
		updatedAt: srcAttr.updatedAt
	};
	let items = JSON.parse(srcAttr.items);

	if (!items || !items.length) {
		acc.push({ itm, children: [] });
		return acc;
	}

	for (let i = 0; i < items.length; i++) {
		let child = items[i];
		let attr = {
			...itm,
			isVerified: child.isVerified,
			createdAt: child.createdAt || itm.createdAt,
			updatedAt: child.updatedAt || itm.updatedAt
		};
		if (!child.values || !child.values.length) {
			acc.push({ itm: attr, children: [] });
			continue;
		}

		if (child.values.length === 1) {
			let val = child.values[0];
			if (val.documentId) {
				attr.documentId = val.documentId;
				acc.push({ itm: attr, children: [] });
				continue;
			}
			let data = Object.keys(val.staticData || {}).map(key => {
				return { role: key, value: val.staticData[key] };
			});

			if (data.length === 1) {
				attr.value = '' + data[0].value;
				attr.updatedAt = val.createdAt || attr.createdAt;
				attr.createdAt = val.updatedAt || attr.updatedAt;
				acc.push({ itm: attr, children: [] });
				continue;
			}
		}

		let children = [];
		for (let j = 0; j < child.values.length; j++) {
			let val = child.values[j];
			if (val.documentId) {
				children.push({
					walletId,
					type: 'document',
					documentId: val.documentId,
					createdAt: val.createdAt || attr.createdAt,
					updatedAt: val.updatedAt || attr.updatedAt
				});
				continue;
			}
			let customType = false;
			if (attr.type === 'phonenumber_countrycode') {
				val.staticData = mapPhoneData(val.staticData);
				customType = true;
			}
			if (attr.type === 'physical_address' || attr.type === 'work_place') {
				val.staticData = mapAddress(val.staticData);
				customType = true;
			}
			let data = Object.keys(val.staticData || {}).map(key => {
				let type = 'text';
				if (customType) {
					type = key;
				}
				return {
					walletId,
					type,
					role: key,
					value: '' + val.staticData[key],
					createdAt: val.createdAt || attr.createdAt,
					updatedAt: val.updatedAt || attr.updatedAt
				};
			});
			children = children.concat(data);
		}
		acc.push({ itm: attr, children });
	}
	return acc;
}

function mapPhoneData(data) {
	return {
		country_code: data.line1,
		country_phone: data.line2
	};
}

function mapAddress(data) {
	return {
		street_address1: data.line1,
		street_address2: data.line2,
		city: data.line3,
		region: data.line5,
		country: data.line6
	};
}

exports.up = async (knex, Promise) => {
	await knex.schema.renameTable('id_attributes', 'id_attributes_old');
	await knex.schema.createTable('id_attributes', table => {
		table.increments('id');
		table
			.integer('walletId')
			.notNullable()
			.references('wallets.id');
		table.string('type').references('id_attribute_types.key');
		table.string('name');
		table.string('value');
		table.integer('isVerified').defaultTo(0);
		table.integer('documentId').references('documentId');
		table.integer('createdAt').notNullable();
		table.integer('updatedAt');
	});
	await knex.schema.createTable('id_attributes_connect', table => {
		table.integer('parentId').references('id_attributes.id');
		table.integer('order').defaultTo(0);
		table.string('role');
		table.integer('childId').references('id_attributes.id');
	});
	let attributes = await knex('id_attributes_old')
		.select()
		.reduce(transformAttrs, []);
	console.log('inserting attributes', attributes);
	for (let j = 0; j < attributes.length; j++) {
		let attr = attributes[j];
		let parentId = await knex('id_attributes').insert(attr.itm);
		for (let i = 0; i < attr.children.length; i++) {
			let child = attr.children[i];
			let role = child.role;
			delete child.role;
			let childId = await knex('id_attributes').insert(child);
			await knex('id_attributes_connect').insert({
				parentId,
				childId,
				role
			});
		}
	}
	// await knex.schema.dropTable('id_attributes_old');
};

exports.down = async (knex, Promise) => {};
